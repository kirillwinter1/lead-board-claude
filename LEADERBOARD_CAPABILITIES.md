# Lead Board — Полное описание возможностей и функций

## Что это

Lead Board — SaaS-платформа для управления IT-доставкой поверх Jira. Автоматически приоритизирует задачи, прогнозирует сроки завершения эпиков на основе реальной загрузки команды и обеспечивает прозрачность процесса разработки.

**Ключевая проблема:** Трудно дать заказчику реалистичные сроки. Ручное планирование не учитывает загрузку команды, зависимости между задачами и конфликтующие приоритеты разных стейкхолдеров — отсюда постоянные срывы сроков.

**Решение:** Lead Board подключается к Jira, анализирует задачи, автоматически приоритизирует работу и рассчитывает прогнозные даты завершения эпиков с учётом реальной мощности команды.

---

## Стек технологий

| Компонент | Технологии |
|-----------|-----------|
| Backend | Java 21, Spring Boot 3, PostgreSQL, Flyway |
| Frontend | React 18, TypeScript, Vite |
| Реалтайм | WebSocket (Planning Poker, уведомления) |
| Интеграция | Jira Cloud REST API, Atlassian OAuth 2.0 (3LO) |
| Деплой | Docker, nginx, docker-compose |

---

## Потребители (роли и доступ)

### 1. Администратор (ADMIN)

**Кто:** Технический руководитель, ответственный за настройку системы.

**Доступные функции:**
- Полное управление пользователями (создание, назначение ролей)
- Настройка workflow: маппинг ролей, статусов, типов задач, типов связей
- Управление всеми командами и участниками
- Запуск и мониторинг синхронизации с Jira
- Настройка OAuth-подключения к Atlassian
- Доступ ко всем разделам без ограничений
- Управление AI Simulation (автоматическая симуляция работы команды)

### 2. Тимлид / Engineering Manager (TEAM_LEAD)

**Кто:** Руководитель команды разработки.

**Доступные функции:**
- Просмотр доски эпиков с прогрессом по ролям (аналитика/разработка/тестирование)
- Ручная приоритизация эпиков и историй (drag & drop с рекомендациями AutoScore)
- Просмотр Timeline/Gantt с прогнозными датами
- Управление составом своей команды (роли, грейды, часы в день)
- Настройка планировочных параметров команды (WIP-лимиты, риск-буфер, рабочие часы)
- Метрики команды: DSR, throughput, forecast accuracy, velocity, burndown
- Персональные метрики участников команды
- Участие в Planning Poker
- Просмотр отчёта Data Quality

### 3. Участник команды (MEMBER)

**Кто:** Разработчик, аналитик, тестировщик.

**Доступные функции:**
- Просмотр доски, Timeline, метрик
- Личный профиль с историей задач и персональным DSR
- Участие в Planning Poker (голосование за оценки)
- Просмотр Data Quality

### 4. Наблюдатель (VIEWER)

**Кто:** Product Manager, Delivery Manager, заказчик.

**Доступные функции:**
- Read-only доступ к доске эпиков
- Просмотр Timeline с прогнозными датами завершения
- Просмотр метрик и отчётов
- Просмотр Data Quality

---

## Основные функциональные блоки

---

### I. Доска эпиков (Board)

**Путь:** `/`

**Назначение:** Центральный экран системы. Отображает иерархию Epic → Story → Subtask с прогрессом, оценками и алертами.

**Возможности:**

- **Иерархическое отображение:** Эпики раскрываются в истории, истории — в подзадачи
- **Прогресс по ролям:** Для каждого эпика и истории видно распределение по ролям (SA/DEV/QA или кастомные) — оценка, залогированное время, процент выполнения
- **Фильтрация:** По команде, по статусам, текстовый поиск
- **Rough Estimates:** Быстрые грубые оценки эпиков (в днях по ролям) до детальной декомпозиции
- **AutoScore:** Автоматический рейтинг приоритетности (7 факторов для эпиков, 9 для историй)
- **Manual Order:** Ручной порядок эпиков с рекомендациями системы (держать / поднять / опустить)
- **Алерты:** Визуальные предупреждения (нет оценок, превышен WIP, просрочен дедлайн, флаг в Jira)
- **Ссылки на Jira:** Каждый элемент кликабелен и ведёт в Jira

---

### II. Timeline / Gantt-диаграмма

**Путь:** `/timeline`

**Назначение:** Визуальный план работ с прогнозными датами, рассчитанными алгоритмом планирования.

**Возможности:**

- **Gantt-диаграмма:** Горизонтальные полосы по эпикам и историям на временной оси
- **Фазы пайплайна:** Каждая полоса разбита на фазы (SA → DEV → QA) с цветовой кодировкой
- **Прогнозные даты:** Start/End для каждого эпика на основе реальной загрузки команды
- **Назначенные исполнители:** Видно, кто назначен на какую фазу каждой истории
- **Зависимости:** Отображение связей между историями (блокировки)
- **Текущая дата:** Вертикальная линия «сегодня» для понимания отставания/опережения
- **Риск-буфер:** 20% запас по умолчанию (настраивается)

---

### III. Алгоритм планирования (Unified Planning)

**Ядро системы.** Рассчитывает прогнозные даты завершения эпиков.

**Входные данные:**
- Команда с участниками (роль, грейд, часы в день)
- Эпики с историями (оценки в подзадачах по ролям)
- Производственный календарь (выходные, российские праздники)
- Риск-буфер (по умолчанию 20%)

**Алгоритм:**
1. Сортирует эпики по `manual_order` (ручной приоритет тимлида)
2. Для каждого эпика извлекает истории, отсортированные по AutoScore
3. Для каждой истории определяет фазы (часы SA/DEV/QA из подзадач)
4. Назначает исполнителей с учётом:
   - **Пайплайн:** SA → DEV → QA (последовательно внутри истории)
   - **Грейд-коэффициенты:** Senior 0.8x, Middle 1.0x, Junior 1.5x
   - **Мощность:** Доступные часы каждого исполнителя в день
   - **Зависимости:** Заблокированные истории ждут разблокировки
5. Рассчитывает рабочие дни через WorkCalendarService (исключая выходные и праздники)
6. Применяет риск-буфер к оценкам

**Результат:**
- Плановые даты начала/окончания каждого эпика
- Расписание фаз каждой истории (даты SA/DEV/QA + назначенные исполнители)
- Процент утилизации каждого исполнителя
- Предупреждения о неоценённых задачах или проблемах

---

### IV. Метрики команды

**Путь:** `/metrics`

**Назначение:** Аналитика эффективности команды и отдельных участников.

**Метрики:**

| Метрика | Формула / Описание |
|---------|-------------------|
| **DSR (Delivery Speed Ratio)** | `(рабочие_дни − дни_паузы) / (оценка / 8ч)`. Зелёный ≤1.1, жёлтый 1.1-1.5, красный >1.5 |
| **Forecast Accuracy** | `плановые_дни / фактические_дни`. Насколько точны прогнозы |
| **Throughput** | Количество завершённых задач за период |
| **Lead Time** | `done_at − created_at` (в рабочих днях) |
| **Cycle Time** | `done_at − started_at` (в рабочих днях) |
| **Velocity** | Залогированные часы vs доступная мощность по неделям |

**Визуализации (5 графиков):**

1. **Scatter Plot — Forecast Accuracy:** План vs факт по каждому эпику
2. **Throughput Chart:** 4-недельная скользящая средняя завершённых задач
3. **Assignee Table:** Персональный DSR, velocity, тренды по каждому участнику
4. **Team Velocity:** Залогированное vs доступная мощность по неделям
5. **Epic Burndown:** Идеальная линия vs фактический прогресс

---

### V. Data Quality (Качество данных)

**Путь:** `/data-quality`

**Назначение:** Автоматическая проверка данных в Jira по 17 правилам. Выявляет проблемы, которые мешают точному планированию.

**Правила (примеры):**

| Правило | Уровень | Описание |
|---------|---------|----------|
| EPIC_NO_ESTIMATE | WARNING | Эпик без оценки (ни rough, ни детальной) |
| SUBTASK_NO_ESTIMATE | WARNING | Подзадача без оценки — прогноз неточный |
| TIME_LOGGED_NOT_IN_SUBTASK | ERROR | Время залогировано не в подзадаче — ломает расчёт |
| EPIC_NO_TEAM | ERROR | Эпик не привязан к команде |
| EPIC_OVERDUE | ERROR | Эпик просрочен (passed due date) |
| EPIC_DONE_OPEN_CHILDREN | ERROR | Эпик закрыт, но есть незакрытые дочерние задачи |
| STORY_NO_SUBTASKS | WARNING | История без подзадач — нет оценок по ролям |

**Вывод:** Список нарушений с группировкой по эпику/истории, уровнем критичности и рекомендациями по исправлению.

---

### VI. Управление командами

**Путь:** `/teams`, `/teams/:id`

**Назначение:** Создание и настройка команд, управление участниками.

**Возможности:**

- **CRUD команд:** Создание, редактирование, удаление команд
- **Участники:** Добавление участников с указанием роли (SA/DEV/QA/кастомная), грейда (Junior/Middle/Senior), доступных часов в день
- **Синхронизация из Atlassian:** Автоматическое подтягивание пользователей из Jira
- **Planning Config:** Настройки планирования на уровне команды:
  - WIP-лимиты по ролям
  - Риск-буфер (%)
  - Рабочие часы в день
  - Методология (Kanban/Scrum — планируется)

---

### VII. Planning Poker

**Путь:** `/poker`, `/poker/:id`

**Назначение:** Совместная оценка задач в реальном времени через WebSocket.

**Возможности:**

- **Шкала Фибоначчи:** 0, 1, 2, 3, 5, 8, 13, 21, ?
- **Реалтайм через WebSocket:** Мгновенное обновление голосов и состояния
- **Скрытое/открытое голосование:** Голоса видны только после reveal
- **Медиана и разброс:** Автоматический расчёт после раскрытия голосов
- **Финальная оценка:** Ведущий сессии фиксирует итоговую оценку
- **Сессии:** Создание сессий с набором историй для оценки

---

### VIII. Профиль участника

**Путь:** `/member/:id`

**Назначение:** Персональная страница участника команды.

**Возможности:**

- **Активные задачи:** Текущие задачи участника с прогрессом
- **Завершённые задачи:** История выполненных задач
- **Персональный DSR:** Тренд DSR участника по времени
- **Загрузка:** Текущая и планируемая загрузка

---

### IX. Настройка Workflow

**Путь:** `/settings`

**Назначение:** Гибкая настройка маппинга между Jira и Lead Board (без хардкода).

**Что настраивается:**

| Настройка | Описание |
|-----------|----------|
| **Роли (Workflow Roles)** | Маппинг типов подзадач Jira → роли Lead Board (SA, DEV, QA или любые кастомные). Порядок определяет пайплайн |
| **Маппинг статусов** | Статусы Jira → категории Lead Board (TODO / IN_PROGRESS / DONE) |
| **Маппинг типов задач** | Типы задач Jira → категории (EPIC / STORY / SUBTASK / IGNORE) |
| **Маппинг связей** | Типы связей Jira → категории (DEPENDENCY / RELATED / IGNORE) |
| **Цвета ролей** | Кастомные цвета для отображения ролей на графиках |
| **Auto-detect** | Автоматическое определение маппингов из метаданных Jira |

---

### X. Интеграция с Jira

**Назначение:** Прозрачная работа поверх существующих процессов в Jira без изменения workflow команды.

**Принципы:**
- **Jira — единственный источник правды:** Lead Board никогда не модифицирует данные в Jira (кроме AI Simulation)
- **Локальный кэш + overlay:** Данные из Jira кэшируются локально; Lead Board добавляет свои данные (manual_order, rough estimates, planning config)

**Возможности:**

| Функция | Описание |
|---------|----------|
| **OAuth 2.0 (Atlassian 3LO)** | Безопасная авторизация через Atlassian |
| **Инкрементальная синхронизация** | Обновление только изменённых задач (JQL: `updated >= lastSyncTime`), каждые 5 минут |
| **Курсорная пагинация** | Корректная обработка больших объёмов данных |
| **Upsert-логика** | Безопасное обновление: создание новых, обновление существующих |
| **Status Changelog** | Отслеживание всех переходов статусов для метрик (Lead Time, Cycle Time) |
| **Иерархия задач** | Epic → Story/Bug → Subtask с ролями через типы подзадач |

---

### XI. Производственный календарь

**Назначение:** Корректный расчёт рабочих дней с учётом выходных и праздников.

**Возможности:**
- Российский производственный календарь (xmlcalendar.ru)
- Автоматическое исключение выходных и праздников из прогнозов
- API для расчёта рабочих дней между датами
- API для добавления N рабочих дней к дате

---

### XII. AI Simulation

**Назначение:** Автоматическая симуляция работы команды для тестирования и демонстрации.

**Возможности:**
- Ежедневная автоматическая симуляция
- Чтение прогноза из UnifiedPlanningService
- Симуляция переходов подзадач (In Work → Review → Done)
- Логирование времени с отклонением ±30%
- Использование OAuth-токенов реальных участников
- Обновление задач в Jira через API

---

### XIII. DSR v2 (Delivery Speed Ratio)

**Назначение:** Улучшенный расчёт скорости доставки с учётом пауз.

**Возможности:**
- **Флаг паузы на эпиках:** Останавливает счётчик DSR на время паузы
- **Конечная точка подзадачи:** Использует максимальную дату завершения подзадачи
- **Live DSR:** Расчёт в реальном времени для эпиков в работе
- **Data Quality предупреждение:** Для эпиков с флагом

---

### XIV. Динамические цвета статусов

**Назначение:** Автоматическая цветовая кодировка статусов на основе workflow-конфигурации.

**Возможности:**
- Статусы TODO — серый
- Статусы IN_PROGRESS — синий
- Статусы DONE — зелёный
- Настраивается через маппинг статусов в настройках

---

## API (для интеграций)

### Основные эндпоинты (96+)

| Группа | Примеры эндпоинтов | Описание |
|--------|-------------------|----------|
| **Board** | `GET /api/board` | Данные доски с иерархией Epic→Story→Subtask |
| **Forecast** | `GET /api/planning/forecast`, `POST /api/planning/recalculate` | Прогнозы и пересчёт |
| **AutoScore** | `GET /api/planning/autoscore/epics/{key}` | Рейтинг приоритетности |
| **Teams** | `GET /api/teams`, `POST /api/teams`, `GET /api/teams/{id}/members` | Управление командами |
| **Metrics** | `GET /api/metrics/summary`, `GET /api/metrics/dsr` | Метрики команды |
| **Poker** | `POST /api/poker/sessions`, `POST /api/poker/stories/{id}/vote` | Planning Poker |
| **Calendar** | `GET /api/calendar/workdays`, `GET /api/calendar/add-workdays` | Производственный календарь |
| **Data Quality** | `GET /api/data-quality` | Проверка качества данных |
| **Sync** | `POST /api/sync/start`, `GET /api/sync/status` | Синхронизация с Jira |
| **OAuth** | `GET /oauth/atlassian/start`, `GET /oauth/atlassian/status` | Авторизация через Atlassian |
| **Config** | `GET /api/config`, `GET/PUT /api/admin/workflow-config/*` | Конфигурация системы |
| **Order** | `PUT /api/epics/{key}/order`, `PUT /api/stories/{key}/order` | Ручная приоритизация |
| **Snapshots** | `GET /api/forecast-snapshots/*` | Ежедневные снимки прогнозов |
| **Health** | `GET /api/health` | Проверка работоспособности |

### WebSocket

| Канал | Назначение |
|-------|-----------|
| `/ws/poker/{sessionId}` | Реалтайм-обновления Planning Poker (голоса, раскрытие, смена истории) |

---

## Бэклог (планируемые возможности)

| # | Функция | Описание |
|---|---------|----------|
| BF2 | Pipeline WIP + Story Visualization | Независимые WIP-лимиты по ролям; визуализация историй на Gantt |
| BF4 | RICE Scoring | Приоритизация по формуле RICE = (Reach × Impact × Confidence) / Effort |
| BF5 | Projects | Уровень проекта над эпиками: кросс-командная видимость, агрегированные метрики |
| BF6 | AI Digest | Еженедельные дайджесты и отчёты при закрытии эпиков (LLM-генерация) |
| BF7 | Notifications | In-app уведомления через WebSocket: статусы, дедлайны, Data Quality, WIP |
| BF10 | Eisenhower Matrix | Тriage орфанных задач (без эпика) по матрице срочность/важность |
| BF11 | Competency Matrix | Матрица компетенций: компоненты × продукты, влияние на планирование |
| BF12 | Sprint Integration | Поддержка Scrum: синхронизация спринтов, визуализация, метрики |
| BF23 | Sprint Retrospective | Встроенный инструмент ретро с WebSocket и экспортом action items в Jira |

---

## Схема данных (ключевые сущности)

| Сущность | Назначение |
|----------|-----------|
| `jira_issues` | Кэш задач из Jira (эпики, истории, подзадачи) |
| `teams` | Команды с planning_config (JSONB) |
| `team_members` | Участники: роль, грейд, часы в день |
| `users` | Пользователи приложения с app_role (ADMIN/TEAM_LEAD/MEMBER/VIEWER) |
| `oauth_tokens` | Токены Atlassian OAuth |
| `status_changelog` | История переходов статусов (для метрик) |
| `calendar_holidays` | Праздники и выходные |
| `forecast_snapshots` | Ежедневные снимки прогнозов |
| `wip_snapshots` | Снимки WIP-истории |
| `poker_sessions` | Сессии Planning Poker |
| `poker_stories` | Истории в сессии Poker |
| `poker_votes` | Голоса участников |
| `workflow_roles` | Динамические роли (SA, DEV, QA, ...) |
| `issue_type_mappings` | Маппинг типов задач Jira → категории |
| `status_mappings` | Маппинг статусов Jira → категории |
| `link_type_mappings` | Маппинг типов связей Jira → категории |

---

## Ключевые бизнес-правила

1. **Оценки и логирование времени — только на подзадачах.** Оценки на историях/эпиках игнорируются.
2. **Назначение исполнителя — только на подзадачах.** Планирование смотрит на assignee подзадач.
3. **1 person-day = 8 часов.**
4. **Прогресс = min(logged_hours / estimated_hours, 1.0).**
5. **Jira — единственный источник правды.** Lead Board не модифицирует данные в Jira.
6. **Грейд-коэффициенты:** Senior 0.8x (быстрее), Middle 1.0x (базовый), Junior 1.5x (медленнее).
7. **Флаг в Jira (flagged):** Работа останавливается, приоритет понижается, задача исключается из планирования.
8. **Блокирующие связи:** "A blocks B" → A получает буст, B задерживается, топологическая сортировка.
9. **AutoScore — только рекомендация.** Реальный порядок определяется manual_order (ручная приоритизация тимлида).
10. **Инкрементальная синхронизация:** Только изменённые задачи, без параллельных синхронизаций.
