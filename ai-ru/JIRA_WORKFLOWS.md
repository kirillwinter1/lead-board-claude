# Jira Workflows

Документация по workflow для разных типов задач. Вся конфигурация хранится в PostgreSQL и управляется через Admin API (`/api/admin/workflow-config`).

---

## Иерархия задач

```
Epic (эпик)
  └── Story / Bug / Task (стори)
        └── Subtask: Аналитика / Разработка / Тестирование (подзадачи)
```

| Уровень | BoardCategory | Описание |
|---------|---------------|----------|
| **Epic** | `EPIC` | Крупная бизнес-фича, содержит стори |
| **Story / Bug / Task** | `STORY` | Единица работы внутри эпика |
| **Subtask** | `SUBTASK` | Подзадача стори, привязана к роли (SA/DEV/QA) |
| Documentation, Meta-task | `IGNORE` | Не отображаются на доске |

---

## Роли pipeline

Pipeline определяет последовательность работы над стори. Каждая роль — это этап.

| # | Code | Название | Цвет | Описание |
|---|------|----------|------|----------|
| 1 | **SA** | System Analyst | `#3b82f6` (синий) | Анализ требований, декомпозиция |
| 2 | **DEV** | Developer | `#10b981` (зелёный) | Разработка, код-ревью |
| 3 | **QA** | QA Engineer | `#f59e0b` (янтарный) | Тестирование, ревью тестов |

**Pipeline:** SA → DEV → QA (порядок задаётся `sort_order` в таблице `workflow_roles`)

### Привязка ролей к подзадачам

| Тип подзадачи в Jira | Роль | Описание |
|----------------------|------|----------|
| Аналитика / Analytics | SA | Работа системного аналитика |
| Разработка / Development | DEV | Работа разработчика |
| Sub-task / Подзадача | DEV | Дефолтная роль для обычных подзадач |
| Тестирование / Testing | QA | Работа тестировщика |

---

## Epic Workflow

Эпик проходит 5 стадий от идеи до завершения:

```
NEW → REQUIREMENTS → PLANNED → IN_PROGRESS → DONE
```

| StatusCategory | Статусы в Jira | Что происходит | AutoScore |
|---------------|---------------|---------------|-----------|
| **NEW** | New, Новый | Эпик создан, работа не начата | -5 |
| **REQUIREMENTS** | Requirements, Требования, Rough Estimate, Оценка, Backlog, To Do | Сбор требований, грубая оценка трудозатрат. Доступна кнопка Rough Estimate | -5 .. +10 |
| **PLANNED** | Planned, Запланировано | Эпик готов к разработке, можно строить прогноз (Forecast). Ожидает очереди | +15 |
| **IN_PROGRESS** | Developing, В разработке, E2E Testing, E2E Тестирование, Acceptance, Приёмка | Активная работа: разработка → E2E тестирование → приёмка | +25 .. +30 |
| **DONE** | Done, Готово, Closed, Закрыто, Resolved, Решено | Эпик завершён, не отображается на доске | 0 |

### Что доступно на каждой стадии

| Возможность | NEW | REQUIREMENTS | PLANNED | IN_PROGRESS | DONE |
|------------|-----|-------------|---------|-------------|------|
| Rough Estimate (грубая оценка) | да | да | нет | нет | нет |
| Forecast (планирование) | нет | нет | да | да | нет |
| Time Logging (учёт времени) | нет | нет | нет | да | нет |
| Отображение на доске | да | да | да | да | нет |

---

## Story Workflow

Стори проходит через 3 категории статусов, при этом IN_PROGRESS разбит на фазы по ролям:

```
NEW → IN_PROGRESS (SA → DEV → QA) → DONE
```

| StatusCategory | Статусы в Jira | Роль | Описание |
|---------------|---------------|------|----------|
| **NEW** | New, Новый | — | Стори создана, не в работе |
| **NEW** | Ready, Готов | — | Готова к взятию в работу |
| **NEW** | Waiting Dev | — | Ожидает разработчика |
| **NEW** | Waiting QA | — | Ожидает тестировщика |
| **NEW** | Ready to Release | — | Готова к релизу |
| **IN_PROGRESS** | Analysis, Анализ | **SA** | Аналитик пишет требования |
| **IN_PROGRESS** | Analysis Review, Ревью анализа | **SA** | Ревью требований |
| **IN_PROGRESS** | Development, Разработка | **DEV** | Активная разработка |
| **IN_PROGRESS** | Dev Review, Ревью разработки | **DEV** | Code review |
| **IN_PROGRESS** | Testing, Тестирование | **QA** | Тестирование |
| **IN_PROGRESS** | Test Review, Ревью тестирования | **QA** | Ревью тестов / регресс |
| **DONE** | Done, Готово | — | Стори закрыта |

### Прогресс по ролям на доске

Для каждой стори на доске отображается прогресс по каждой роли:

```
[SA ████░░ 60%] [DEV █░░░░░ 20%] [QA ░░░░░░ 0%]
```

Прогресс рассчитывается как `logged_time / estimated_time` по подзадачам данной роли.

---

## Subtask Workflow

Подзадачи имеют простой 3-стадийный workflow:

```
NEW → IN_PROGRESS → DONE
```

| StatusCategory | Статусы в Jira | Описание |
|---------------|---------------|----------|
| **NEW** | New, Новый | Подзадача создана |
| **IN_PROGRESS** | In Progress, В работе | В процессе выполнения |
| **IN_PROGRESS** | Review, Ревью | На проверке |
| **DONE** | Done, Готово | Подзадача закрыта |

---

## Типы задач (Issue Type Mapping)

Полный маппинг Jira-типов на категории доски:

| Jira Type | BoardCategory | Роль (для SUBTASK) |
|-----------|---------------|-------------------|
| Epic | EPIC | — |
| Эпик | EPIC | — |
| Story | STORY | — |
| История | STORY | — |
| Bug | STORY | — |
| Баг | STORY | — |
| Task | STORY | — |
| Задача | STORY | — |
| Sub-task | SUBTASK | DEV |
| Подзадача | SUBTASK | DEV |
| Аналитика | SUBTASK | SA |
| Analytics | SUBTASK | SA |
| Разработка | SUBTASK | DEV |
| Development | SUBTASK | DEV |
| Тестирование | SUBTASK | QA |
| Testing | SUBTASK | QA |
| Documentation | IGNORE | — |
| Meta-task | IGNORE | — |

---

## Типы связей (Link Type Mapping)

| Jira Link Type | LinkCategory | Описание |
|---------------|-------------|----------|
| Blocks | **BLOCKS** | Блокирующая зависимость (A блокирует B) |
| Relates | **RELATED** | Информационная связь |
| Duplicate | IGNORE | Игнорируется |
| Cloners | IGNORE | Игнорируется |

Только связи **BLOCKS** учитываются при планировании и отображаются как зависимости на доске.

---

## AutoScore — приоритизация эпиков

AutoScore определяет порядок эпиков на доске и в планировщике. Чем выше балл, тем выше приоритет.

### Score Weights по статусам

| Статус | Вес | Логика |
|--------|-----|--------|
| New, Новый, Backlog, To Do, Open | **-5** | Не начатые — низкий приоритет |
| Requirements, Требования, Analysis | **+5** | Начаты требования |
| Rough Estimate, Оценка, Estimation | **+10** | Есть оценка |
| Planned, Запланировано, Ready | **+15** | Запланированы |
| Developing, В разработке, Development, In Progress | **+25** | Активная разработка |
| E2E Testing, Acceptance, Приёмка | **+30** | Почти готовы — максимальный приоритет |

### Принцип: "Закончить начатое"

Эпики на поздних стадиях workflow получают наибольший вес, что обеспечивает приоритет завершения начатой работы над началом новой.

### Остальные факторы AutoScore

| Фактор | Диапазон | Описание |
|--------|----------|----------|
| Status Weight | -5 .. +30 | Позиция в workflow (см. выше) |
| Jira Priority | 0-20 | Highest=20, High=15, Medium=10, Low=5 |
| Due Date | 0-25 | Экспоненциальный рост к дедлайну |
| Progress | 0-10 | % выполнения (logged/estimate) |
| Size | -5 .. +5 | Меньше = выше (без оценки = -5) |
| Age | 0-5 | Логарифм от возраста |
| Manual Boost | ±∞ | Ручная корректировка |

---

## Грубая оценка (Rough Estimate)

Доступна когда эпик в статусе NEW или REQUIREMENTS.

Формат: оценка в днях по каждой роли pipeline:
```json
{"SA": 3, "DEV": 5, "QA": 2}
```

Используется для:
- Отображения прогресса по ролям на доске (до появления реальных подзадач)
- Предварительного планирования (Forecast)
- Оценки трудозатрат команды

---

## Планирование (Forecast)

Доступно когда эпик в статусе PLANNED или IN_PROGRESS.

Pipeline планирования повторяет порядок ролей: **SA → DEV → QA**.

Для каждой роли:
1. Собираются оставшиеся часы по подзадачам этой роли
2. Рассчитывается доступная ёмкость команды (с учётом WIP limits)
3. Строится прогноз завершения (дата)

---

## Конфигурация

Вся конфигурация хранится в PostgreSQL (6 таблиц) и управляется через:

- **Admin UI**: Settings → Workflow Configuration (`/board/workflow`)
- **Admin API**: `GET/PUT /api/admin/workflow-config/*`
- **Валидация**: `POST /api/admin/workflow-config/validate`

Изменения применяются мгновенно — WorkflowConfigService сбрасывает кэш при обновлении.

### Jira Metadata

Для помощи в настройке доступны метаданные из Jira:
- `GET /api/admin/jira-metadata/issue-types` — типы задач проекта
- `GET /api/admin/jira-metadata/statuses` — статусы проекта
- `GET /api/admin/jira-metadata/link-types` — типы связей

---

## История изменений

| Дата | Изменение |
|------|-----------|
| 2026-02-13 | F29: перенос конфигурации из хардкода/YAML в PostgreSQL + Admin UI |
| 2026-01-26 | Документирование workflows, обновление AutoScore |
