# F15. WIP Limits — Учёт лимитов в планировании

## Цель

Реалистичное планирование с учётом ограничений на количество параллельной работы.

**Ключевая ценность:** Более точные прогнозы за счёт моделирования реального потока работы.

---

## Проблема

### Текущая модель (без WIP)

```
Все 5 эпиков работают параллельно:

Epic 1 ═══════════════════════════════►
Epic 2 ═══════════════════════════════►
Epic 3 ═══════════════════════════════►
Epic 4 ═══════════════════════════════►
Epic 5 ═══════════════════════════════►

Capacity размазывается на все эпики.
Каждый получает 20% ресурсов.
```

**Проблемы:**
- Нереалистично — команда не работает над 10 эпиками одновременно
- Топ-приоритеты завершаются позже (ресурсы делятся)
- Низкая предсказуемость

### Целевая модель (с WIP)

```
WIP лимит = 3

Epic 1 ████████████░░░░░░░░░░░░░░░░░░░
Epic 2 ████████████████░░░░░░░░░░░░░░░
Epic 3 ████████████████████░░░░░░░░░░░
Epic 4        [ждёт]  ████████████████
Epic 5              [ждёт]  ██████████

Только 3 эпика активны одновременно.
Каждый получает 33% ресурсов.
Топ-приоритеты завершаются быстрее.
```

---

## Конфигурация

### Текущие настройки (уже есть в БД)

```json
{
  "wipLimits": {
    "team": 6,    // Общий лимит на команду
    "sa": 2,      // Макс. эпиков в SA фазе
    "dev": 3,     // Макс. эпиков в DEV фазе
    "qa": 2       // Макс. эпиков в QA фазе
  }
}
```

### API (уже есть)

```
GET  /api/teams/{id}/planning-config
PUT  /api/teams/{id}/planning-config
```

---

## Scope

### Этап 1: Базовый WIP (MVP) ✅

**Backend:**
- [x] Учёт командного WIP лимита в ForecastService
- [x] Эпики за пределами лимита начинаются когда освобождается слот
- [x] Перерасчёт Expected Done с учётом очереди

**Frontend:**
- [x] Отображение текущего WIP в Summary: "WIP 3/6"
- [x] Индикатор очереди для эпиков за пределами WIP
- [x] Tooltip показывает позицию в очереди и дату ожидания

**Тесты:**
- [x] Расчёт дат с WIP = 3 и 5 эпиками
- [x] Эпик за пределами WIP начинается после завершения предыдущего
- [x] 5 unit-тестов для WIP функциональности

### Этап 2: Роль-специфичные лимиты ✅

**Backend:**
- [x] Учёт WIP по ролям (SA/DEV/QA)
- [x] Эпик может ждать входа в фазу даже если предыдущая завершена
- [x] Моделирование "пробок" на фазах
- [x] RoleWipStatus в ForecastResponse (SA/DEV/QA current/limit/exceeded)
- [x] PhaseWaitInfo в EpicForecast (информация об ожидании по фазам)

**Frontend:**
- [x] Показ WIP по ролям: "SA: 2/2, DEV: 2/3, QA: 1/2"
- [x] Визуализация ожидания между фазами в tooltip

**Тесты:**
- [x] roleWipStatusIncludedInResponse
- [x] phaseWaitInfoIncludedInEpicForecast
- [x] epicWaitsForRoleWipSlot
- [x] devWipLimitAffectsPhaseStart
- [x] combinedTeamAndRoleWipLimits

### Этап 3: Подсветка и аналитика ✅

**Frontend:**
- [x] Подсветка превышения WIP (жёлтый/красный)
  - normal (синий) - менее 80% лимита
  - warning (жёлтый) - 80%+ или на лимите
  - exceeded (красный) - превышен лимит
- [x] Рекомендации по оптимизации WIP (WipInsightsPanel)
  - Анализ командного WIP
  - Обнаружение bottlenecks по ролям
  - Анализ очереди
  - Анализ ожидания между фазами
- [ ] График утилизации WIP во времени (требует backend изменений)

---

## Алгоритм (Этап 1)

### Текущий алгоритм ForecastService

```java
1. Получить эпики отсортированные по AutoScore
2. Для каждого эпика:
   a. Рассчитать остаток работы по ролям
   b. Рассчитать даты фаз с учётом capacity
3. Вернуть прогнозы
```

### Новый алгоритм с WIP

```java
1. Получить эпики отсортированные по AutoScore
2. Получить WIP лимит команды
3. Инициализировать очередь активных эпиков (макс = WIP)
4. Для каждого эпика:
   a. Если активных < WIP:
      - Добавить в активные
      - Начало = сегодня (или конец предыдущей фазы)
   b. Иначе:
      - Найти ближайшую дату завершения активного эпика
      - Начало = эта дата
      - Заменить завершённый эпик на новый
   c. Рассчитать даты фаз
   d. Capacity делится на количество активных эпиков
5. Вернуть прогнозы с учётом очереди
```

### Пример

```
Входные данные:
- 5 эпиков: E1(10d), E2(8d), E3(12d), E4(6d), E5(4d)
- WIP лимит = 3
- Team capacity = 24ч/день

Расчёт:
День 0:  Активные = [E1, E2, E3], capacity = 8ч каждому
День 8:  E2 готов → Активные = [E1, E3, E4]
День 10: E1 готов → Активные = [E3, E4, E5]
День 12: E3 готов
День 14: E4 готов (начал день 8, работал 6д)
День 14: E5 готов (начал день 10, работал 4д)

Результат:
E1: дни 0-10
E2: дни 0-8
E3: дни 0-12
E4: дни 8-14  (ждал 8 дней)
E5: дни 10-14 (ждал 10 дней)
```

---

## Модель данных

### EpicForecast (расширение)

```java
public record EpicForecast(
    String epicKey,
    BigDecimal autoScore,
    LocalDate expectedDone,
    // ... existing fields ...

    // Новые поля для WIP
    Integer queuePosition,      // Позиция в очереди (null если активен)
    LocalDate queuedUntil,      // До какой даты в очереди
    Boolean isWithinWip         // Входит ли в WIP лимит
) {}
```

### ForecastResponse (расширение)

```java
public record ForecastResponse(
    // ... existing fields ...

    // Новые поля
    WipStatus wipStatus
) {
    public record WipStatus(
        Integer limit,
        Integer current,
        Boolean exceeded
    ) {}
}
```

---

## API изменения

### GET /api/planning/forecast (расширение ответа)

```json
{
  "calculatedAt": "2026-01-24T12:00:00Z",
  "teamId": 1,
  "wipStatus": {
    "limit": 3,
    "current": 3,
    "exceeded": false
  },
  "epics": [
    {
      "epicKey": "LB-123",
      "expectedDone": "2026-02-15",
      "queuePosition": null,
      "queuedUntil": null,
      "isWithinWip": true
    },
    {
      "epicKey": "LB-456",
      "expectedDone": "2026-03-01",
      "queuePosition": 1,
      "queuedUntil": "2026-02-15",
      "isWithinWip": false
    }
  ]
}
```

---

## UI изменения

### Summary Panel

```
Было:   5 epics · 3 on track · 2 at risk
Стало:  5 epics · 3 on track · 2 at risk · WIP 3/3
```

### Timeline визуализация

```
Активные (в WIP):
│ ▶ LB-123  │  ████████████████████    │

В очереди:
│ ⏳ LB-456  │       ░░░░░████████████  │
                    ↑
              Серый = ожидание в очереди
```

### Tooltip для эпика в очереди

```
┌──────────────────────────────────┐
│ LB-456: Feature X                │
│ ─────────────────────────────────│
│ Queue position: #1               │
│ Waiting until: Feb 15            │
│ Expected start: Feb 16           │
│ Expected done: Mar 1             │
└──────────────────────────────────┘
```

---

## Тесты

### Unit тесты ForecastService

```java
@Test
void epicsWithinWipStartImmediately()

@Test
void epicsBeyondWipWaitForSlot()

@Test
void wipLimitOfOneCreatesSequentialPlan()

@Test
void capacityDividedAmongActiveEpicsOnly()

@Test
void queuePositionCalculatedCorrectly()
```

### Integration тесты

```java
@Test
void forecastApiReturnsWipStatus()

@Test
void recalculateRespectsWipLimits()
```

---

## Зависимости

- F13 (AutoScore) — для приоритизации очереди
- F5 (Team Backend) — для получения WIP конфигурации

---

## Оценка трудозатрат

| Этап | Backend | Frontend | Тесты |
|------|---------|----------|-------|
| 1. Базовый WIP | 4ч | 2ч | 2ч |
| 2. Роль-специфичные | 4ч | 3ч | 2ч |
| 3. Подсветка | 1ч | 3ч | 1ч |
| **Итого** | **9ч** | **8ч** | **5ч** |

---

## Риски и ограничения

1. **Сложность расчёта** — пересечение роль-специфичных лимитов может создавать неочевидные результаты
2. **Производительность** — алгоритм с очередью O(n²), нужна оптимизация для больших списков
3. **UX сложность** — нужно понятно объяснить пользователю почему эпик в очереди

---

## Открытые вопросы

1. Как быть с эпиками In Progress которые уже превышают WIP?
   - Вариант A: Игнорировать лимит для уже начатых
   - Вариант B: Показывать предупреждение

2. Учитывать ли частичную занятость?
   - Эпик на 50% готовности занимает 1 слот или 0.5?

3. Нужен ли "мягкий" WIP (рекомендация) vs "жёсткий" (блокировка)?
